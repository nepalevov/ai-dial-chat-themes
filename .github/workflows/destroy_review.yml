name: Destroy Review

on:
  pull_request: # TODO: replace with pull_request_target ???
    branches: [development]
    types: [closed]

jobs:
  cancel-workflows:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    permissions:
      actions: write
    steps:
      - name: "Cancel Workflow"
        uses: styfle/cancel-workflow-action@85880fa0301c86cca9da44039ee3bb12d3bedbfa # v0.12.1
        with:
          ignore_sha: true
          workflow_id: "all"

  destroy:
    runs-on: ubuntu-latest
    needs:
      - cancel-workflows
    steps:
      - run: |
          echo "Destroying the application in the cluster..."
          echo "Namespace: ${{ github.repository_id }}-pr-${{ github.event.pull_request.number }}"

  delete-gh-environment:
    runs-on: ubuntu-latest
    needs:
      - cancel-workflows
    steps:
      - name: Sleep to debug
        run: |
          # HACK: delay between workflow cancellation needed
          sleep 10
      - name: Delete Github environment
        uses: strumwolf/delete-deployment-environment@a4825dd9648c57da8437a4885c3fcad58beac69c # v3.0.0
        with:
          token: ${{ secrets.ACTIONS_BOT_TOKEN }}
          environment: pr-${{ github.event.pull_request.number }}
